from IPython.display import Audio
from scipy.io import wavfile

# Считывание аудиофайла и частоты дискретизации
samplerate, audio_file = wavfile.read('valim.wav')
# Задание начала и окончания отрывка аудиофайла 
# начало с 10 сек, длительность 10 сек
start = samplerate * 14 
end = start + samplerate * 10
# Вывод аудиофайла с помощью пакета Audio
Audio(data= audio_file[start:end, 0], rate=samplerate)


from sklearn.decomposition import PCA
import numpy as np
def pca_reduce(signal, n_components, block_size=1024):
    # Обнуление сигнала, чтобы он был кратен block_size
    samples = len(signal) # определение длины сигнала
    hanging = block_size - np.mod(samples, block_size) # нахождение разницы сигнала к обнулению
    padded = np.lib.pad(signal, (0, hanging), 'constant', constant_values=0) # создание нового массива, кратного block_size 
    
    # Изменение формы сигнала, чтобы он имел размер block_size
    reshaped = padded.reshape((len(padded) // block_size, block_size))
    
    # Запуск PCA сжатия
    pca = PCA(n_components=n_components)
    pca.fit(reshaped)
    transformed = pca.transform(reshaped)
    reconstructed = pca.inverse_transform(transformed).reshape((len(padded)))
    return pca, transformed, reconstructed


audio_file_left = audio_file[:,0]

# Применение функции сжатия к аудиофайлу
_, _, reconstructed = pca_reduce(audio_file_left, 1024, 1024)

# Вывод аудиофайла с помощью пакета Audio
Audio(data=reconstructed[start:end], rate=samplerate)



# Применение функции сжатия к аудиофайлу
_, _, reconstructed = pca_reduce(audio_file_left, 32, 1024)

# Вывод аудиофайла с помощью пакета Audio
Audio(data=reconstructed[start:end], rate=samplerate)

#wavfile.write("2.wav", samplerate, reconstructed[2].astype(np.int16))
